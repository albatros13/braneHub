{% extends 'base.html' %}
{% block title %}Data Answers Preview · BraneHub{% endblock %}
{% block content %}
<div class="row mb-3">
  <div class="col-12 d-flex justify-content-between align-items-center">
    <div>
      <a href="{{ url_for('onboarding_request_detail', req_id=req._id) }}" class="text-decoration-none">← Back to Request</a>
      <h1 class="h4 mt-2 mb-0">Applicant Data Format Answers</h1>
      <div class="text-muted small">Project: {{ project.title }} ({{ project.id }}) · Applicant: {{ req.username }}</div>
    </div>
    {% if download_href %}
    <div>
      <a class="btn btn-sm btn-outline-secondary" href="{{ download_href }}" target="_blank">Download JSON</a>
    </div>
    {% endif %}
  </div>
</div>

{% if load_error %}
  <div class="alert alert-warning" role="alert">{{ load_error }}</div>
{% endif %}

{% if structured %}
<div class="row g-4">
  <div class="col-12 col-xl-6">
    <div class="card h-100">
      <div class="card-body">
        <h5 class="card-title">Storage</h5>
        {% set st = structured.get('storage', {}) %}
        {% if st %}
        <dl class="row mb-0">
          <dt class="col-sm-4">Files</dt>
          <dd class="col-sm-8">{% if st.get('files') is iterable and st.get('files') is not string %}{{ st.get('files')|join(', ') }}{% else %}{{ st.get('files') or '' }}{% endif %}</dd>
          <dt class="col-sm-4">Databases</dt>
          <dd class="col-sm-8">{% if st.get('databases') is iterable and st.get('databases') is not string %}{{ st.get('databases')|join(', ') }}{% else %}{{ st.get('databases') or '' }}{% endif %}</dd>
          <dt class="col-sm-4">APIs/Streams</dt>
          <dd class="col-sm-8">{% if st.get('apis_streams') is iterable and st.get('apis_streams') is not string %}{{ st.get('apis_streams')|join(', ') }}{% else %}{{ st.get('apis_streams') or '' }}{% endif %}</dd>
          <dt class="col-sm-4">Object Store</dt>
          <dd class="col-sm-8">{% if st.get('object_store') is iterable and st.get('object_store') is not string %}{{ st.get('object_store')|join(', ') }}{% else %}{{ st.get('object_store') or '' }}{% endif %}</dd>
          <dt class="col-sm-4">Source of truth</dt>
          <dd class="col-sm-8">{{ st.get('source_of_truth') or '' }}</dd>
        </dl>
        {% else %}
          <p class="text-muted mb-0">No storage information.</p>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="col-12 col-xl-6">
    <div class="card h-100">
      <div class="card-body">
        <h5 class="card-title">Schema Contracts</h5>
        {% set sch = structured.get('schema', {}) %}
        {% if sch %}
        <div class="table-responsive">
          <table class="table table-sm mb-0">
            <thead><tr><th>Type</th><th>Value</th></tr></thead>
            <tbody>
              {% for k, v in sch.items() %}
                <tr>
                  <td class="small text-muted">{{ k }}</td>
                  <td>
                    {% if v is iterable and v is not string %}
                      {{ v|join(', ') }}
                    {% else %}
                      {{ v }}
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
          <p class="text-muted mb-0">No schema information.</p>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="col-12 col-xl-6">
    <div class="card h-100">
      <div class="card-body">
        <h5 class="card-title">Delivery</h5>
        {% set d = structured.get('delivery', {}) %}
        {% if d %}
        <dl class="row mb-0">
          <dt class="col-sm-4">Methods</dt>
          <dd class="col-sm-8">{% if d.get('methods') is iterable and d.get('methods') is not string %}{{ d.get('methods')|join(', ') }}{% else %}{{ d.get('methods') or '' }}{% endif %}</dd>
          <dt class="col-sm-4">Files format</dt>
          <dd class="col-sm-8">{{ d.get('files_format') or '' }}</dd>
          <dt class="col-sm-4">API spec</dt>
          <dd class="col-sm-8">{{ d.get('api_spec') or '' }}</dd>
          <dt class="col-sm-4">DB details</dt>
          <dd class="col-sm-8">{{ d.get('db_details') or '' }}</dd>
          <dt class="col-sm-4">Object store path</dt>
          <dd class="col-sm-8">{{ d.get('object_store_path') or '' }}</dd>
          <dt class="col-sm-4">Stream details</dt>
          <dd class="col-sm-8">{{ d.get('stream_details') or '' }}</dd>
        </dl>
        {% else %}
          <p class="text-muted mb-0">No delivery information.</p>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="col-12 col-xl-6">
    <div class="card h-100">
      <div class="card-body">
        <h5 class="card-title">Metadata</h5>
        {% set m = structured.get('meta', {}) %}
        {% if m %}
        <dl class="row mb-0">
          {% for k, v in m.items() %}
            <dt class="col-sm-4">{{ k }}</dt>
            <dd class="col-sm-8">{% if v is iterable and v is not string %}{{ v|join(', ') }}{% else %}{{ v }}{% endif %}</dd>
          {% endfor %}
        </dl>
        {% else %}
          <p class="text-muted mb-0">No metadata provided.</p>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="col-12">
    <div class="card h-100">
      <div class="card-body">
        <h5 class="card-title">Operational Details</h5>
        {% set ops = structured.get('ops', {}) %}
        {% if ops %}
        <dl class="row mb-0">
          <dt class="col-sm-3">Update cadence</dt>
          <dd class="col-sm-9">{{ ops.get('update_cadence') or '' }}</dd>
          <dt class="col-sm-3">Size profile</dt>
          <dd class="col-sm-9">{{ ops.get('size_profile') or '' }}</dd>
          <dt class="col-sm-3">Error retries</dt>
          <dd class="col-sm-9">{{ ops.get('error_retries') or '' }}</dd>
          <dt class="col-sm-3">Contact</dt>
          <dd class="col-sm-9">{{ ops.get('contact') or '' }}</dd>
        </dl>
        {% else %}
          <p class="text-muted mb-0">No operational details.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% else %}
  <p class="text-muted">No structured data-format answers to display.</p>
{% endif %}

{% if source_rel %}
  <div class="mt-3 text-muted small">Source file: {% if download_href %}<a href="{{ download_href }}" target="_blank">{{ source_rel }}</a>{% else %}<code>{{ source_rel }}</code>{% endif %}</div>
{% endif %}
{% endblock %}
